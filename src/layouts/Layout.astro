---
/* No frontmatter needed */
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content="AgCalculator — quick, reliable farm & ranch calculators. Simple tools for grain, hay, pasture, irrigation and more." />
    <meta name="referrer" content="strict-origin-when-cross-origin" />

    <!-- Performance hints -->
    <link rel="preconnect" href="https://plausible.io" />
    <link rel="preconnect" href="https://pagead2.googlesyndication.com" crossorigin />
    <link rel="dns-prefetch" href="https://plausible.io" />
    <link rel="dns-prefetch" href="https://pagead2.googlesyndication.com" />

    <!-- Favicon / Icons -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png" />
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png" />

    <!-- PWA -->
    <link rel="manifest" href="/manifest.webmanifest" />
    <meta name="theme-color" content="#2F855A" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="AgCalculator" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />

    <!-- Consent + AdSense loader (loads AdSense ONLY after user grants ads consent) -->
    <script is:inline>
      (function () {
        const KEY = 'agc_ads_consent'; // 'granted' | 'denied'
        const $ = (sel) => document.querySelector(sel);

        function hasChoice() {
          const v = localStorage.getItem(KEY);
          return v === 'granted' || v === 'denied';
        }
        function grant() {
          localStorage.setItem(KEY, 'granted');
          loadAdsense();
          hideBanner();
        }
        function deny() {
          localStorage.setItem(KEY, 'denied');
          hideBanner();
        }

        function loadAdsense() {
          if (document.getElementById('adsbygooglejs')) return;
          const s = document.createElement('script');
          s.id = 'adsbygooglejs';
          s.async = true;
          s.crossOrigin = 'anonymous';
          s.src = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4050846968323757';
          document.head.appendChild(s);
        }

        function createBanner() {
          if (document.getElementById('consent-banner')) return;
          const el = document.createElement('div');
          el.id = 'consent-banner';
          el.role = 'dialog';
          el.ariaLabel = 'Privacy choices for advertising';
          el.style.cssText =
            'position:fixed;left:1rem;right:1rem;bottom:1rem;z-index:9999;background:#fff;border:1px solid #cbd5e1;border-radius:12px;max-width:720px;margin:0 auto;padding:1rem;box-shadow:0 8px 24px rgba(0,0,0,.08);';
          el.innerHTML = `
            <div style="display:flex;gap:.9rem;align-items:flex-start">
              <div style="flex:1;min-width:0">
                <strong style="display:block;font-size:1rem">Privacy choices</strong>
                <div style="color:#64748b;margin-top:.25rem;font-size:.95rem;line-height:1.45">
                  We use Google AdSense for advertising and only load it after you allow ads. Our analytics (Plausible) is cookie-free.
                  You can change this anytime via “Privacy choices” in the footer.
                </div>
              </div>
              <div style="display:flex;gap:.5rem;flex-wrap:wrap">
                <button id="consent-allow" style="padding:.55rem .8rem;border:none;border-radius:10px;background:#2F855A;color:#fff;cursor:pointer">Allow ads</button>
                <button id="consent-deny"  style="padding:.55rem .8rem;border:1px solid #cbd5e1;border-radius:10px;background:#fff;cursor:pointer">No ads</button>
              </div>
            </div>`;
          document.body.appendChild(el);
          document.getElementById('consent-allow').onclick = grant;
          document.getElementById('consent-deny').onclick = deny;
        }
        function hideBanner() { document.getElementById('consent-banner')?.remove(); }

        // API for pages/links to reopen the banner
        window.addEventListener('open-consent', () => {
          localStorage.removeItem(KEY);
          createBanner();
        });

        // Footer inline link handler (added in markup below)
        window.addEventListener('load', () => {
          const link = document.getElementById('privacy-choices-inline');
          if (link) {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              window.dispatchEvent(new CustomEvent('open-consent'));
            });
          }
        });

        // First-load behavior
        if (hasChoice()) {
          if (localStorage.getItem(KEY) === 'granted') loadAdsense();
        } else {
          if (document.readyState === 'complete') createBanner(); else window.addEventListener('load', createBanner);
        }
      })();
    </script>

    <!-- Plausible (cookie-free) -->
    <script is:inline>
      window.plausible = window.plausible || function(){ (window.plausible.q = window.plausible.q || []).push(arguments); };
    </script>
    <script defer data-domain="agcalculator.com" src="https://plausible.io/js/script.js"></script>

    <!-- Organization schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "AgCalculator",
      "url": "https://agcalculator.com",
      "logo": "https://agcalculator.com/icons/icon-192.png",
      "sameAs": ["mailto:info@cleverhayseed.com"]
    }
    </script>

    <!-- Base styles -->
    <style>
      :root{ --green:#2F855A; --slate:#334155; --muted:#64748B; --bg:#F8FAFC }
      *{ box-sizing:border-box }
      html,body{ height:100% }
      body{
        margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif;
        background:var(--bg); color:var(--slate); line-height:1.5;
      }
      a{ color:var(--green); text-decoration:none }
      a:focus-visible, button:focus-visible{ outline:2px solid var(--green); outline-offset:2px }
      .wrap{ max-width:960px; margin:0 auto; padding:0 1rem }
      .card{
        background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:1rem;
        box-shadow:0 2px 8px rgba(0,0,0,.03)
      }
    </style>

    <!-- Pages can inject title/canonicals/JSON-LD here -->
    <slot name="head" />
  </head>

  <body>
    <slot />

    <!-- Site-wide footer -->
    <footer style="padding:2rem 0;color:var(--muted)">
      <div class="wrap">
        <small>
          © {new Date().getFullYear()} AgCalculator ·
          <a href="/about/">About</a> ·
          <a href="/privacy/">Privacy</a> ·
          <a href="/terms/">Terms</a> ·
          <a href="mailto:info@cleverhayseed.com">Contact</a> ·
          <a id="privacy-choices-inline" href="#">Privacy choices</a>
        </small>
      </div>
    </footer>

    <!-- Optional: “Install app” link handler (only runs if an element with id="install-app" exists) -->
    <script is:inline>
      (function () {
        const installLink = document.getElementById('install-app');
        if (!installLink) return;
        let deferredPrompt = null;

        const isIOS = () => /iphone|ipad|ipod/i.test(navigator.userAgent);

        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
        });

        installLink.addEventListener('click', async (evt) => {
          evt.preventDefault();

          if (deferredPrompt) {
            deferredPrompt.prompt();
            try {
              const { outcome } = await deferredPrompt.userChoice;
              if (outcome) { try { window.plausible && window.plausible('A2HS installed'); } catch {} }
            } catch {}
            deferredPrompt = null;
            return;
          }

          if (isIOS()) {
            alert('On iPhone/iPad: tap the Share button → “Add to Home Screen”.');
          } else {
            alert('Use your browser menu → “Install app” or “Add to Home screen”.');
          }
        });
      })();
    </script>

    <!-- Service worker -->
    <script is:inline>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').catch(() => {});
        });
      }
    </script>
  </body>
</html>
